# M-Pesa STK Push Integration Guide

This document explains how the M-Pesa STK Push payment integration works in the PAKA Go delivery app.

## Overview

The M-Pesa integration allows users to pay for delivery services using their mobile money accounts through Safaricom's STK Push API. This provides a seamless, secure payment experience for Kenyan users.

## Features

- **STK Push Payments**: Initiate payments directly from the app
- **Real-time Payment Status**: Track payment progress and confirmation
- **Phone Number Validation**: Ensure valid Kenyan mobile numbers
- **Payment History**: Complete transaction tracking and history
- **Error Handling**: Comprehensive error handling and user feedback
- **Web Compatibility**: Mock payments for web platform testing

## Configuration

### M-Pesa API Credentials

The following credentials are configured in `services/mpesa.ts`:

```typescript
const MPESA_CONFIG = {
  clientId: 'c0ShysKAT4YHFg63LCC1ihKZrAUg-fWYOp3v_BF3_xc',
  clientSecret: 'fgNXPNXzQwQuwQcjklj-1FwT8SCi8enuTxIGd6kO348',
  apiKey: '1f21d5f2c00510756b2bec75fac74aa7de379ad3',\n  baseUrl: 'https://sandbox.safaricom.co.ke', // Sandbox for testing\n  businessShortCode: '174379', // Test shortcode\n  passkey: 'bfb279f9aa9bdbcf158e97dd71a467cd2e0c893059b10f78e6b72ada1ed2c919',\n  callbackUrl: 'https://your-app.com/api/mpesa/callback',\n};\n```\n\n**Note**: These are sandbox credentials for testing. For production, you'll need to:\n1. Register with Safaricom for production credentials\n2. Update the `baseUrl` to production endpoint\n3. Use your production business shortcode and passkey\n4. Set up a proper callback URL endpoint\n\n## Implementation Details\n\n### 1. M-Pesa Service (`services/mpesa.ts`)\n\nThe core service handles:\n- OAuth token management\n- STK Push initiation\n- Payment status queries\n- Phone number validation\n- Callback processing\n\n### 2. Payment Store (`stores/payment-store.ts`)\n\nManages payment transaction state:\n- Transaction creation and updates\n- Payment status tracking\n- Transaction history\n- Persistent storage\n\n### 3. Payment UI (`app/payment/index.tsx`)\n\nProvides user interface for:\n- Payment method selection\n- Phone number input with validation\n- Payment processing feedback\n- Real-time status updates\n\n### 4. Payment History (`app/payment/history.tsx`)\n\nDisplays:\n- Complete transaction history\n- Payment status and details\n- Receipt numbers and timestamps\n- Error messages for failed payments\n\n## Payment Flow\n\n### 1. Order Creation\n```typescript\n// User selects M-Pesa as payment method during booking\nconst orderData = {\n  paymentMethod: 'mpesa',\n  paymentTerm: 'pay_now', // or 'pay_on_delivery'\n  // ... other order details\n};\n```\n\n### 2. Payment Initiation\n```typescript\n// When user proceeds to payment\nconst paymentRequest = {\n  phoneNumber: '+254712345678',\n  amount: 450,\n  orderId: 'ORD-123',\n  description: 'Payment for delivery'\n};\n\nconst response = await mpesaService.initiateSTKPush(paymentRequest);\n```\n\n### 3. STK Push Process\n1. User enters phone number\n2. App validates phone number format\n3. STK Push request sent to M-Pesa API\n4. User receives prompt on their phone\n5. User enters M-Pesa PIN to complete payment\n6. App queries payment status\n7. Order status updated based on payment result\n\n### 4. Payment Confirmation\n```typescript\n// Query payment status\nconst status = await mpesaService.querySTKPushStatus(checkoutRequestId);\n\nif (status.success) {\n  // Update order and transaction status\n  updatePaymentStatus(orderId, 'paid');\n  updateTransactionStatus(transactionId, 'completed');\n}\n```\n\n## Phone Number Validation\n\nThe service validates Kenyan mobile numbers:\n- Accepts formats: `0712345678`, `712345678`, `+254712345678`, `254712345678`\n- Converts to M-Pesa format: `254712345678`\n- Validates mobile prefixes (7xx and 1xx series)\n\n## Error Handling\n\nComprehensive error handling for:\n- Network connectivity issues\n- Invalid phone numbers\n- Insufficient funds\n- Transaction timeouts\n- API authentication failures\n\n## Testing\n\n### Sandbox Testing\nUse the provided sandbox credentials to test:\n- Use test phone numbers provided by Safaricom\n- Test various scenarios (success, failure, timeout)\n- Verify callback handling\n\n### Web Platform\nThe service automatically provides mock responses on web platform for testing the UI flow.\n\n## Production Deployment\n\n### 1. Get Production Credentials\n1. Apply for M-Pesa API access through Safaricom\n2. Complete KYC and business verification\n3. Receive production credentials\n\n### 2. Update Configuration\n```typescript\nconst MPESA_CONFIG = {\n  baseUrl: 'https://api.safaricom.co.ke', // Production URL\n  businessShortCode: 'YOUR_SHORTCODE',\n  passkey: 'YOUR_PRODUCTION_PASSKEY',\n  // ... other production credentials\n};\n```\n\n### 3. Set Up Callback Endpoint\nImplement a backend endpoint to handle M-Pesa callbacks:\n```typescript\n// Example callback handler\napp.post('/api/mpesa/callback', (req, res) => {\n  const callbackData = mpesaService.processCallback(req.body);\n  \n  // Update payment status in database\n  if (callbackData.resultCode === 0) {\n    // Payment successful\n    updatePaymentStatus(callbackData.checkoutRequestId, 'completed');\n  } else {\n    // Payment failed\n    updatePaymentStatus(callbackData.checkoutRequestId, 'failed');\n  }\n  \n  res.status(200).json({ ResultCode: 0, ResultDesc: 'Success' });\n});\n```\n\n## Security Considerations\n\n1. **Credential Security**: Store credentials securely (environment variables)\n2. **Callback Validation**: Validate callback authenticity\n3. **Transaction Verification**: Always verify payment status\n4. **User Data Protection**: Encrypt sensitive payment data\n5. **Rate Limiting**: Implement rate limiting for payment requests\n\n## Troubleshooting\n\n### Common Issues\n\n1. **Invalid Phone Number**\n   - Ensure phone number is in correct format\n   - Check if number is registered for M-Pesa\n\n2. **STK Push Timeout**\n   - User didn't respond to prompt\n   - Network connectivity issues\n   - Implement retry mechanism\n\n3. **Authentication Errors**\n   - Check credentials are correct\n   - Verify token hasn't expired\n   - Ensure proper base64 encoding\n\n4. **Callback Not Received**\n   - Verify callback URL is accessible\n   - Check firewall settings\n   - Implement webhook verification\n\n## Support\n\nFor M-Pesa API support:\n- Safaricom Developer Portal: https://developer.safaricom.co.ke/\n- M-Pesa API Documentation\n- Safaricom Support Team\n\n## Future Enhancements\n\n1. **B2C Payments**: Implement refunds and payouts\n2. **QR Code Payments**: Add QR code payment option\n3. **Recurring Payments**: Subscription-based payments\n4. **Multi-currency**: Support for other currencies\n5. **Payment Analytics**: Advanced payment reporting\n